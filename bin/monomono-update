#!/bin/bash
# ==============================================================================
# MonoMono Update-Skript v2.1 (mit intelligenter PAT-Auth)
# ==============================================================================
CONFIG_FILE="$HOME/.monomono_config"

# --- 1. LADE KONFIGURATION & AUTHENTIFIZIERE ---
# Pr√ºfe, ob die Konfigurationsdatei und der PAT vorhanden sind
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

# Wenn der PAT fehlt, starte den Erstellungs-Workflow
if [ -z "$MONOMONO_PAT" ]; then
    echo "--------------------------------------------------------------------"
    echo "üîë INFO: Ein pers√∂nlicher Zugriffstoken (PAT) wird f√ºr die Authentifizierung ben√∂tigt."
    echo "‚ÄºÔ∏è  AKTION ERFORDERLICH: √ñffne https://github.com/settings/tokens/new"
    echo "   Anleitung: W√§hle die Scopes 'repo' UND 'workflow' aus, generiere den Token und kopiere ihn."
    echo "--------------------------------------------------------------------"
    PAT=""
    while [ -z "$PAT" ]; do
        read -s -p "üëâ Bitte f√ºge den kopierten Token hier ein und dr√ºcke ENTER: " PAT; echo
    done
    
    # Validiere und speichere den neuen Token
    echo "-> √úberpr√ºfe den Access Token..."
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $PAT" https://api.github.com/user)
    if [ "$HTTP_STATUS" -ne 200 ]; then
        echo "‚ùå FEHLER: Der Token ist ung√ºltig (HTTP-Status: $HTTP_STATUS)." >&2; exit 1
    fi
    echo "‚úî Access Token ist g√ºltig."
    echo "MONOMONO_PAT='$PAT'" >> "$CONFIG_FILE"
    MONOMONO_PAT=$PAT
fi

# Authentifiziere die aktuelle Sitzung mit dem Token
export GH_TOKEN=$MONOMONO_PAT
echo "‚úî Authentifizierung f√ºr diese Sitzung gesetzt."
echo "--------------------------------------------------------------------"

# --- 2. WORKFLOW STARTEN ---
if [ -z "$1" ]; then
  echo "‚ùå Fehler: Du musst den Pfad zum Fusions-Repo angeben." >&2
  echo "   Beispiel: monomono-update dein-name/dein-fusions-repo" >&2
  exit 1
fi
REPO_PATH=$1

echo "‚ÑπÔ∏è Starte den Update-Workflow f√ºr das Repo: $REPO_PATH"
gh workflow run sync.yml --repo "$REPO_PATH" || { echo "‚ùå Fehler beim Starten des Workflows."; exit 1; }

echo "‚úÖ Befehl zum Aktualisieren gesendet. Verfolge den Fortschritt hier:"
echo "   https://github.com/$REPO_PATH/actions"