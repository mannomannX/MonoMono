#!/bin/bash
# MonoMono Disconnect-Skript v1.0
source "$(dirname "$0")/../lib/i18n.sh"
setup_language

echo "MonoMono Disconnect Assistent"
echo "--------------------------------"

read -p "$TEXT_DISCONNECT_FUSION_REPO" FUSION_REPO
if [ -z "$FUSION_REPO" ]; then echo "❌ Fehler: Eingabe darf nicht leer sein."; exit 1; fi

read -p "$TEXT_DISCONNECT_SUB_REPOS" SUB_REPOS
if [ -z "$SUB_REPOS" ]; then echo "❌ Fehler: Eingabe darf nicht leer sein."; exit 1; fi

echo "-> Suche und entferne Webhooks in den Sub-Repos..."
DISPATCH_URL="https://api.github.com/repos/$FUSION_REPO/dispatches"

for repo in $(echo $SUB_REPOS | sed "s/,/ /g"); do
    echo "   - Prüfe Repo: $repo"
    HOOK_IDS=$(gh api "repos/$repo/hooks" --jq ".[] | select(.config.url == \"$DISPATCH_URL\") | .id" 2>/dev/null)
    
    if [ -z "$HOOK_IDS" ]; then
        echo "     ℹ️ Kein passender Webhook gefunden."
        continue
    fi

    for hook_id in $HOOK_IDS; do
        echo "     - Lösche Webhook mit ID: $hook_id"
        gh api --method DELETE "repos/$repo/hooks/$hook_id" --silent || echo "     ❌ Fehler beim Löschen."
    done
done

echo
# Dynamische Textausgabe für die Bestätigung
printf -v confirm_prompt "$TEXT_DISCONNECT_DELETE_CONFIRM" "$FUSION_REPO"
read -p "$confirm_prompt" DELETE_REPO
if [[ "$DELETE_REPO" == "j" || "$DELETE_REPO" == "J" || "$DELETE_REPO" == "y" || "$DELETE_REPO" == "Y" ]]; then
    echo "-> Lösche Repository: $FUSION_REPO"
    gh repo delete "$FUSION_REPO" --yes
fi

echo "✅ Trennung abgeschlossen."