#!/bin/bash
# ==============================================================================
# MONOMONO-DISCONNECT v1.7 (Final & Complete)
# ==============================================================================
# Trennt ausgew√§hlte Sub-Repos, aktualisiert den Haupt-Workflow UND
# st√∂√üt einen finalen Sync-Lauf zum Aufr√§umen an.
# ==============================================================================

auth_check() {
    if ! gh auth status >/dev/null 2>&1; then
        echo "‚ö†Ô∏è  Du scheinst nicht bei der GitHub CLI angemeldet zu sein."
        read -p "? Soll 'gh auth login' jetzt ausgef√ºhrt werden? (j/n) " choice
        if [[ "$choice" =~ ^[YyJj]$ ]]; then gh auth login; else echo "‚ùå Abbruch."; exit 1; fi
    fi
    GITHUB_USER=$(gh api user --jq .login)
    echo "‚úî Authentifiziert als '$GITHUB_USER'."
}

# --- HAUPTLOGIK ---
auth_check

# 1. Ziel-Repo abfragen
read -p "? Von welchem Fusions-Repo soll getrennt werden? (Format: user/repo): " FUSION_REPO
FUSION_REPO=$(echo "$FUSION_REPO" | xargs)
if [ -z "$FUSION_REPO" ]; then echo "‚ùå Abbruch: Kein Repo angegeben."; exit 1; fi

# 2. PAT f√ºr alle API-Operationen abfragen
echo "--------------------------------------------------------------------"
echo "üîë INFO: Ein pers√∂nlicher Zugriffstoken (PAT) mit 'repo' und 'workflow' Scopes wird ben√∂tigt."
echo "--------------------------------------------------------------------"
PAT=""
while [ -z "$PAT" ]; do
    read -s -p "üëâ Bitte f√ºge den kopierten Token hier ein: " PAT; echo
done

# 3. Bestehende Konfiguration auslesen
echo "-> Versuche, die Konfiguration aus '$FUSION_REPO' zu lesen..."
WORKFLOW_RESPONSE=$(GH_TOKEN=$PAT gh api "repos/$FUSION_REPO/contents/.github/workflows/sync.yml" 2>/dev/null)
SUB_REPOS_OLD=""

if echo "$WORKFLOW_RESPONSE" | jq -e '.sha' > /dev/null; then
    echo "‚úî Konfiguration gefunden. Extrahiere verbundene Repos..."
    WORKFLOW_CONTENT=$(echo "$WORKFLOW_RESPONSE" | jq -r .content | base64 --decode)
    WORKFLOW_SHA=$(echo "$WORKFLOW_RESPONSE" | jq -r .sha)
    SUB_REPOS_OLD=$(echo "$WORKFLOW_CONTENT" | grep -oP "REPOS_TO_SYNC='([^']*)'" | sed -E "s/REPOS_TO_SYNC='([^']*)'/\1/")
else
    echo "‚ö†Ô∏è  Warnung: Konnte 'sync.yml' nicht finden. Wechsle in den manuellen Modus."
fi

# 4. Auswahl der zu trennenden Repos
if [ -n "$SUB_REPOS_OLD" ]; then
    echo "-> W√§hle die zu trennenden Sub-Repos:"
    REPOS_TO_DISCONNECT=$(echo "$SUB_REPOS_OLD" | tr ',' '\n' | fzf --multi --prompt="Trennen> ")
else
    read -p "? Bitte gib die zu trennenden Sub-Repos manuell ein (user/repo1,user/repo2,...): " REPOS_TO_DISCONNECT
fi

if [ -z "$REPOS_TO_DISCONNECT" ]; then echo "‚ùå Abbruch: Keine Repos ausgew√§hlt oder eingegeben."; exit 1; fi

# 5. Trennungslogik
for repo in $(echo "$REPOS_TO_DISCONNECT" | tr ',' ' '); do
    echo "-> Trenne $repo..."
    GH_TOKEN=$PAT gh secret delete MONOMONO_FUSION_REPO --repo "$repo" &>/dev/null
    GH_TOKEN=$PAT gh secret delete MONOMONO_APP_TOKEN --repo "$repo" &>/dev/null
    SHA_TRIGGER=$(GH_TOKEN=$PAT gh api "repos/$repo/contents/.github/workflows/monomono-trigger.yml" --jq .sha &>/dev/null)
    if [ -n "$SHA_TRIGGER" ]; then
        GH_TOKEN=$PAT gh api --method DELETE "repos/$repo/contents/.github/workflows/monomono-trigger.yml" -f message="build: Remove monomono trigger" -f sha="$SHA_TRIGGER" &>/dev/null
    fi
done

# 6. Haupt-Workflow aktualisieren
RUN_FINAL_SYNC=false
if [ -n "$WORKFLOW_SHA" ]; then
    echo "-> Aktualisiere Haupt-Workflow in '$FUSION_REPO'..."
    SUB_REPOS_NEW=$SUB_REPOS_OLD
    for repo_to_remove in $(echo "$REPOS_TO_DISCONNECT" | tr ',' ' '); do
        SUB_REPOS_NEW=$(echo ",$SUB_REPOS_NEW," | sed "s#,$repo_to_remove,##g" | sed 's/^,//;s/,$//')
    done

    if [ -n "$SUB_REPOS_NEW" ]; then
        NEW_WORKFLOW_CONTENT=$(echo "$WORKFLOW_CONTENT" | sed "s|REPOS_TO_SYNC='$SUB_REPOS_OLD'|REPOS_TO_SYNC='$SUB_REPOS_NEW'|")
        GH_TOKEN=$PAT gh api --method PUT "repos/$FUSION_REPO/contents/.github/workflows/sync.yml" \
           -f message="build: Disconnect sub-repo(s)" \
           -f content="$(echo -n "$NEW_WORKFLOW_CONTENT" | base64)" \
           -f sha="$WORKFLOW_SHA" >/dev/null
        echo "‚úî Haupt-Workflow wurde aktualisiert."
        RUN_FINAL_SYNC=true
    else
        GH_TOKEN=$PAT gh api --method DELETE "repos/$FUSION_REPO/contents/.github/workflows/sync.yml" \
           -f message="build: Remove final monomono workflow" -f sha="$WORKFLOW_SHA" > /dev/null
        echo "‚úî Alle Repos getrennt. Haupt-Workflow wurde entfernt."
    fi
fi

# 7. Finalen Sync-Lauf zum Aufr√§umen ansto√üen
if [ "$RUN_FINAL_SYNC" = true ]; then
    echo "-> Sto√üe finalen Sync-Lauf zum Aufr√§umen an..."
    gh workflow run sync.yml --repo "$FUSION_REPO"
fi

echo "‚úÖ Prozess abgeschlossen."