#!/bin/bash
# MonoMono Disconnect-Skript v1.1

echo "MonoMono Disconnect Assistent"
echo "--------------------------------"
read -p "? Gib den Pfad zum Fusions-Repo ein (z.B. user/repo): " FUSION_REPO
if [ -z "$FUSION_REPO" ]; then echo "❌ Fehler: Eingabe darf nicht leer sein."; exit 1; fi

read -p "? Gib die zu trennenden Sub-Repos ein (user/repo1,user/repo2,...): " SUB_REPOS
if [ -z "$SUB_REPOS" ]; then echo "❌ Fehler: Eingabe darf nicht leer sein."; exit 1; fi

# PAT abfragen, um die nötigen Rechte zum Löschen zu haben
echo "Ein PAT mit 'repo' und 'workflow' Rechten wird benötigt, um die Konfiguration zu entfernen."
read -s -p "? Bitte füge deinen PAT hier ein: " PAT
echo

# Konfiguration aus den Sub-Repos entfernen
echo "-> Entferne Konfiguration aus den Sub-Repos..."
for repo in $(echo $SUB_REPOS | sed "s/,/ /g"); do
    echo "   - Bereinige Repo: $repo"
    
    # Secrets löschen
    echo "     - Lösche Secrets..."
    gh secret delete MONOMONO_FUSION_REPO --repo "$repo"
    gh secret delete MONOMONO_PAT --repo "$repo"

    # Trigger-Workflow löschen (via Git)
    echo "     - Entferne Trigger-Workflow..."
    TEMP_SUB_DIR=$(mktemp -d)
    # Klonen mit dem bereitgestellten PAT
    git clone "https://x-access-token:$PAT@github.com/$repo.git" "$TEMP_SUB_DIR" >/dev/null 2>&1
    
    if [ -f "$TEMP_SUB_DIR/.github/workflows/monomono-trigger.yml" ]; then
        cd "$TEMP_SUB_DIR" || exit
        git config user.name "MonoMono Script"
        git config user.email "bot@users.noreply.github.com"
        git rm .github/workflows/monomono-trigger.yml
        git commit -m "chore: Remove MonoMono sync trigger"
        git push >/dev/null 2>&1
        cd - >/dev/null
    else
        echo "     - Kein Trigger-Workflow zum Entfernen gefunden."
    fi
    rm -rf "$TEMP_SUB_DIR"
done

# Optional das Fusions-Repo löschen
read -p "? Soll auch das Fusions-Repo '$FUSION_REPO' auf GitHub gelöscht werden? (j/n) " DELETE_REPO
if [[ "$DELETE_REPO" =~ ^[YyJj]$ ]]; then
    echo "-> Lösche Repository: $FUSION_REPO"
    gh repo delete "$FUSION_REPO" --yes
fi

echo "✅ Trennung abgeschlossen."