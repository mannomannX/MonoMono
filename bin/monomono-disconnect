#!/bin/bash
# ==============================================================================
# MonoMono Disconnect-Skript v1.2 (mit intelligenter PAT-Auth)
# ==============================================================================
CONFIG_FILE="$HOME/.monomono_config"

# --- 1. LADE KONFIGURATION & AUTHENTIFIZIERE ---
if [ -f "$CONFIG_FILE" ]; then
    source "$CONFIG_FILE"
fi

if [ -z "$MONOMONO_PAT" ]; then
    echo "--------------------------------------------------------------------"
    echo "ðŸ”‘ INFO: Ein persÃ¶nlicher Zugriffstoken (PAT) wird benÃ¶tigt, um aufzurÃ¤umen."
    read -s -p "ðŸ‘‰ Bitte fÃ¼ge einen gÃ¼ltigen Token hier ein und drÃ¼cke ENTER: " PAT; echo
    HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: token $PAT" https://api.github.com/user)
    if [ "$HTTP_STATUS" -ne 200 ]; then
        echo "âŒ FEHLER: Der Token ist ungÃ¼ltig (HTTP-Status: $HTTP_STATUS)." >&2; exit 1
    fi
    MONOMONO_PAT=$PAT
fi
export GH_TOKEN=$MONOMONO_PAT
echo "âœ” Authentifizierung fÃ¼r diese Sitzung gesetzt."
echo "--------------------------------------------------------------------"

# --- 2. FÃœHRE DISCONNECT AUS ---
echo "MonoMono Disconnect Assistent"
read -p "? Gib den Pfad zum Fusions-Repo ein (z.B. user/repo): " FUSION_REPO
if [ -z "$FUSION_REPO" ]; then echo "âŒ Fehler: Eingabe darf nicht leer sein."; exit 1; fi

read -p "? Gib die zu trennenden Sub-Repos ein (user/repo1,user/repo2,...): " SUB_REPOS
if [ -z "$SUB_REPOS" ]; then echo "âŒ Fehler: Eingabe darf nicht leer sein."; exit 1; fi

# PAT abfragen, um die nÃ¶tigen Rechte zum LÃ¶schen zu haben
echo "Ein PAT mit 'repo' und 'workflow' Rechten wird benÃ¶tigt, um die Konfiguration zu entfernen."
read -s -p "? Bitte fÃ¼ge deinen PAT hier ein: " PAT
echo

# Konfiguration aus den Sub-Repos entfernen
echo "-> Entferne Konfiguration aus den Sub-Repos..."
for repo in $(echo $SUB_REPOS | sed "s/,/ /g"); do
    echo "   - Bereinige Repo: $repo"
    
    # Secrets lÃ¶schen
    echo "     - LÃ¶sche Secrets..."
    gh secret delete MONOMONO_FUSION_REPO --repo "$repo"
    gh secret delete MONOMONO_PAT --repo "$repo"

    # Trigger-Workflow lÃ¶schen (via Git)
    echo "     - Entferne Trigger-Workflow..."
    TEMP_SUB_DIR=$(mktemp -d)
    # Klonen mit dem bereitgestellten PAT
    git clone "https://x-access-token:$PAT@github.com/$repo.git" "$TEMP_SUB_DIR" >/dev/null 2>&1
    
    if [ -f "$TEMP_SUB_DIR/.github/workflows/monomono-trigger.yml" ]; then
        cd "$TEMP_SUB_DIR" || exit
        git config user.name "MonoMono Script"
        git config user.email "bot@users.noreply.github.com"
        git rm .github/workflows/monomono-trigger.yml
        git commit -m "chore: Remove MonoMono sync trigger"
        git push >/dev/null 2>&1
        cd - >/dev/null
    else
        echo "     - Kein Trigger-Workflow zum Entfernen gefunden."
    fi
    rm -rf "$TEMP_SUB_DIR"
done

# Optional das Fusions-Repo lÃ¶schen
read -p "? Soll auch das Fusions-Repo '$FUSION_REPO' auf GitHub gelÃ¶scht werden? (j/n) " DELETE_REPO
if [[ "$DELETE_REPO" =~ ^[YyJj]$ ]]; then
    echo "-> LÃ¶sche Repository: $FUSION_REPO"
    gh repo delete "$FUSION_REPO" --yes
fi

echo "âœ… Trennung abgeschlossen."